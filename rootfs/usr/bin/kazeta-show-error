#!/bin/bash
# /usr/bin/kazeta-show-error
# This script runs as root to take over the console and show the error.

# 1. Nuke Gamescope to release the screen/input
killall -9 gamescope 2>/dev/null

# 2. Force display to TTY1
chvt 1

# 3. Redirect this script's I/O to the physical console
# Since we run via sudo, we have permission to write to /dev/tty1
exec < /dev/tty1 > /dev/tty1 2>&1

export TERM=linux

# Use Raw ANSI Escape Codes to disable blanking
# \033[9;0]  = Set blank timeout to 0 (disable)
# \033[13]   = Unblank the screen immediately
# \033[14;0] = Set VESA powerdown to 0 (disable)
echo -e "\033[9;0]\033[14;0]\033[13]"

# Backup with setterm (forcing the device)
setterm --term linux -blank 0 -powersave off -powerdown 0 > /dev/tty1

# 4. UI Logic
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

clear
echo -e "${RED}"
echo "             _  __           _                      "
echo "            | |/ /__ _ _____| |_ __ _               "
echo "            | ' // _\` |_  / _ \ __/ _\` |          "
echo "            | . \ (_| |/ /  __/ || (_| |            "
echo "            |_|\_\__,_/___\___|\__\__,_+            "
echo "                   SYSTEM ERROR                     "
echo -e "${NC}"
echo "----------------------------------------------------"
echo -e "${YELLOW}The cartridge failed to launch.${NC}"
echo "Possible causes: Missing executable, bad config, or runtime error."
echo ""
echo -e "${GREEN}SESSION LOG (Last 30 lines):${NC}"
echo "----------------------------------------------------"

# Read the log (which was updated by the calling script)
tail -n 30 /var/kazeta/session.log

echo "----------------------------------------------------"
echo ""
echo "Press the Power button to shut down."
echo ""
