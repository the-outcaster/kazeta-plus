#! /bin/bash

# Save the PID of this script, which represents the game session
#echo $$ > /tmp/kazeta_game.pid

set -x

# Check for the --bios flag
if [ "$1" == "--bios" ]; then
    gamescope --filter pixel -- kazeta-bios
    exit 0
fi

# check for autoboot disabled
BIOS_CONFIG_FILE="$HOME/.local/share/kazeta-plus/config.toml"

if [ -f "$BIOS_CONFIG_FILE" ]; then
    if grep -q "^\s*autoboot\s*=\s*false\s*$" "$BIOS_CONFIG_FILE"; then
        echo "DEBUG: Autoboot disabled in $BIOS_CONFIG_FILE. Booting to BIOS."
        gamescope --filter pixel -- kazeta-bios
        exit 0
    fi
fi

BASE_DIR="$HOME/.local/share/kazeta"
if [[ ! -d "${BASE_DIR}" ]]; then
    mkdir -p "${BASE_DIR}"
fi

BASE_EXT="/media"
result=$(ls -1 /media | wc -l)
if [[ "$result" == "0" ]]; then
    BASE_EXT="/run/media/${USER}"
    if [[ ! -d "${BASE_EXT}" ]]; then
        BASE_EXT="/run/media"
    fi
fi

function get_attribute {
    attribute=$1
    shift
    info_file="$@"
    cat "${info_file}" | grep "^${attribute}=" | head -1 | cut -d= -f2-
}

function start_playtime_capture {
    while true; do
        sleep 60
        date --iso-8601=seconds > .kazeta/var/playtime_end
    done
}

# Check if a specific .kzi file was passed as an argument
if [ -n "$1" ] && [ -f "$1" ]; then
    cart_info="$1"
else
    # If not, wait up to 2 seconds for any cart
    for i in $(seq 1 20); do
        cart_info=$(find ${BASE_EXT} -maxdepth 2 -name "*.kzi" -exec grep -l "^SetAsDefaultGame=true$" {} + 2>/dev/null | head -1)

        if [ -f "$cart_info" ]; then
            echo "DEBUG: Found default cart: $cart_info"
            break
        fi

        cart_info=$(find ${BASE_EXT} -maxdepth 2 -name "*.kzi" 2>/dev/null | head -1)

        if [ -f "$cart_info" ]; then
            echo "DEBUG: Found first available cart: $cart_info"
            break
        else
            sleep 0.1
        fi
    done
fi

if [[ ! -f "${cart_info}" ]]; then
    echo "DEBUG: No valid cart_info, launching BIOS."
    gamescope --filter pixel -- kazeta-bios
    exit 0
fi

cart_path=$(dirname "${cart_info}")
cart_id="$(get_attribute 'Id' ${cart_info})"
cart_icon="${cart_path}/$(get_attribute 'Icon' ${cart_info})"

mkdir -p "${BASE_DIR}/cache/${cart_id}"
cp "${cart_info}" "${BASE_DIR}/cache/${cart_id}/metadata.kzi"
if [[ -f "${cart_icon}" ]]; then
    cp "${cart_icon}" "${BASE_DIR}/cache/${cart_id}/icon.png"
fi

lower="${cart_path}"
upper="${BASE_DIR}/saves/default/${cart_id}"
work="${BASE_DIR}/run/work"
target="${BASE_DIR}/run/cart"
runtimedir="${BASE_DIR}/run/runtime"

if [[ ! -d "${upper}" ]]; then
    rm -f "${upper}"
    mkdir -p "${upper}"
fi

# --- Helper function to find a runtime in a given directory ---
function find_runtime {
    local rt_name="$1"
    local base_dir="$2"
    local found_path=""

    if [ -f "${base_dir}/${rt_name}" ]; then
        found_path="${base_dir}/${rt_name}"
    elif [ -f "${base_dir}/${rt_name}.kzr" ]; then
        found_path="${base_dir}/${rt_name}.kzr"
    else
        local glob_match=$(ls -1 "${base_dir}/${rt_name}-"*.kzr 2>/dev/null | head -1)
        if [ -f "$glob_match" ]; then
            found_path="$glob_match"
        fi
    fi
    echo "$found_path"
}

# --- Define runtime paths ---
SYSTEM_RUNTIME_DIR="/usr/share/kazeta/runtimes"
DVD_RUNTIME_DIR="${cart_path}"
DEFAULT_RUNTIME="${SYSTEM_RUNTIME_DIR}/none.kzr"

runtime_name="$(get_attribute 'Runtime' ${cart_info})"
runtime=""

if [ -n "$runtime_name" ]; then
    echo "DEBUG: Runtime requested: '$runtime_name'"
    echo "DEBUG: Checking for runtime on internal drive..."
    runtime=$(find_runtime "$runtime_name" "$SYSTEM_RUNTIME_DIR")

    if [ -z "$runtime" ]; then
        echo "DEBUG: Runtime not found internally. Checking DVD drive ($DVD_RUNTIME_DIR)..."
        runtime=$(find_runtime "$runtime_name" "$DVD_RUNTIME_DIR")
        if [ -n "$runtime" ]; then
            echo "DEBUG: Found runtime on DVD. Load times may be slow."
        fi
    fi

    if [ -z "$runtime" ]; then
        echo "WARNING: Runtime '$runtime_name' not found. Defaulting to 'none'."
        runtime="$DEFAULT_RUNTIME"
    fi
else
    echo "DEBUG: No runtime specified. Defaulting to 'none'."
    runtime="$DEFAULT_RUNTIME"
fi

if [ ! -f "$runtime" ]; then
    echo "CRITICAL: Runtime file '$runtime' not found!"
fi

echo "DEBUG: Using runtime: $runtime"

# =======================================================
# [NEW] SELF-HEALING: AGGRESSIVE CLEANUP
# =======================================================
# We do not check 'if mounted' because a directory can be 'busy'
# (held by a zombie process) without technically being a mountpoint.

echo "DEBUG: Performing pre-launch cleanup..."

# 1. Kill any zombie processes holding the directories open
# -k = kill, -9 = SIGKILL (force), -m = mountpoint (optional but good safety)
sudo fuser -k -9 "${target}" 2>/dev/null
sudo fuser -k -9 "${runtimedir}" 2>/dev/null

# 2. Force Lazy Unmount (Blindly)
# We redirect stderr to null because we don't care if it fails
# (i.e., if it wasn't mounted to begin with).
sudo umount -l "${target}" 2>/dev/null
sudo umount -l "${runtimedir}" 2>/dev/null

# 3. Clean up work dir to prevent stale overlay errors
# If the work dir has "whiteout" files from a crashed session, mount will fail.
sudo rm -rf "${work}"
mkdir -p "${work}"

echo "DEBUG: Cleanup complete."
# =======================================================

# --- Mount the filesystem ---
sudo kazeta-mount "${lower}" "${upper}" "${work}" "${target}" "${runtime}" "${runtimedir}"
MOUNT_EXIT_CODE=$?

# =======================================================
# [NEW] CRITICAL CHECK: Stop if mount failed
# =======================================================
if [ $MOUNT_EXIT_CODE -ne 0 ]; then
    echo "CRITICAL: kazeta-mount failed with code $MOUNT_EXIT_CODE. Aborting launch."
    exit 1
fi
# =======================================================

# Get the post-exec command *before* setting the trap
post_exec_cmd=$(get_attribute 'PostExec' ${cart_info})
[[ -n "$post_exec_cmd" ]] && post_exec_cmd+=";"

trap "\
    if [ -n \"\$PLAYTIME_PID\" ]; then kill \"\$PLAYTIME_PID\" 2>/dev/null; fi; \
    popd 2>/dev/null; \
    echo 'DEBUG: Running PostExec cleanup...'; \
    ${post_exec_cmd} \
    sudo kazeta-mount --unmount "${target}" "${runtimedir}"; \
    sudo rm -rf "${work}"; \
    sudo rm -rf "${upper}/.kazeta/share"; \
    rmdir --ignore-fail-on-non-empty "${upper}/.kazeta"; \
" EXIT

export HOME="${BASE_DIR}/run/cart"

unset XDG_CONFIG_HOME
unset XDG_CACHE_HOME
unset XDG_DATA_HOME
unset XDG_STATE_HOME
pushd "${HOME}"

# --- Run PreExec command ---
cart_preexec="$(get_attribute 'PreExec' ${cart_info})"
if [ -n "$cart_preexec" ]; then
    echo "DEBUG: Running PreExec command: $cart_preexec"
    eval "$cart_preexec"
    echo "DEBUG: PreExec complete."
fi

cart_exec="$(get_attribute 'Exec' ${cart_info})"
cart_gsopts="$(get_attribute 'GamescopeOptions' ${cart_info})"
echo "$cart_exec" > /tmp/kazeta-cart-exec

# append previously captured playtime to the log
if [ -f .kazeta/var/playtime_start ] && [ -f .kazeta/var/playtime_end ]; then
    echo "$(cat .kazeta/var/playtime_start) $(cat .kazeta/var/playtime_end)" >> .kazeta/var/playtime.log
fi
rm -f .kazeta/var/playtime_start
rm -f .kazeta/var/playtime_end

mkdir -p .kazeta/var
date --iso-8601=seconds > .kazeta/var/playtime_start
start_playtime_capture &
PLAYTIME_PID=$!

# --- EXECUTION ---

START_TIME=$(date +%s)

# Run Gamescope
gamescope ${cart_gsopts} -- ./.kazeta/share/run /tmp/kazeta-cart-exec | grep -v "pressure-vessel-wrap" > "${HOME}/.kazeta/var/run.log" 2>&1
EXIT_CODE=$?

set +x

END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))
CRASH_THRESHOLD=10

if [ $EXIT_CODE -ne 0 ] && [ $DURATION -lt $CRASH_THRESHOLD ]; then
    # Error Logic
    if [ -n "$PLAYTIME_PID" ]; then
        kill "$PLAYTIME_PID" 2>/dev/null
    fi

    PHYSICAL_LOG_PATH="/var/kazeta/saves/default/${cart_id}/.kazeta/var/run.log"

    echo "" >> /var/kazeta/session.log
    echo "========== [KAZETA+] GAME LAUNCH FAILURE ==========" >> /var/kazeta/session.log
    echo "Timestamp: $(date)" >> /var/kazeta/session.log
    echo "Cart ID: ${cart_id}" >> /var/kazeta/session.log
    echo "Duration: ${DURATION} seconds (Threshold: ${CRASH_THRESHOLD}s)" >> /var/kazeta/session.log
    echo "Exit Code: ${EXIT_CODE}" >> /var/kazeta/session.log
    echo "Log Path: ${PHYSICAL_LOG_PATH}" >> /var/kazeta/session.log
    echo "Last 20 lines of game execution log:" >> /var/kazeta/session.log

    if [ -f "${PHYSICAL_LOG_PATH}" ]; then
        if [ -s "${PHYSICAL_LOG_PATH}" ]; then
            tail -n 20 "${PHYSICAL_LOG_PATH}" >> /var/kazeta/session.log
        else
            echo "---------------------------------------------------" >> /var/kazeta/session.log
            echo "[!] run.log is empty." >> /var/kazeta/session.log
            echo "The application exited immediately without producing output." >> /var/kazeta/session.log
        fi
    else
        echo "No run.log found at ${PHYSICAL_LOG_PATH}" >> /var/kazeta/session.log
    fi
    echo "===================================================" >> /var/kazeta/session.log

    sudo /usr/bin/kazeta-show-error
fi
