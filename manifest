#! /bin/bash

export VERSION="2025-1" # Updated version for the new release
export SYSTEM_DESC="Kazeta+" # Updated to Kazeta+
export SYSTEM_NAME="kazeta-plus"
export USERNAME="gamer"
export SIZE="5000MB"
export ARCHIVE_DATE=$(date -d 'yesterday' +%Y/%m/%d)
export WEBSITE="https://kazeta.org"
export DOCUMENTATION_URL="https://kazeta.org"
export BUG_REPORT_URL="https://github.com/the-outcaster/kazeta-plus/issues"

export KERNEL_PACKAGE="linux"

export PACKAGES="\
	accountsservice \
	fuse2 \
	fuse3 \
	fuse-overlayfs \
	gamescope \
	htop \
	inputplumber \
	less \
	lib32-libxfixes \
	lib32-nvidia-utils \
	lib32-pipewire \
	lib32-vulkan-intel \
	lib32-vulkan-mesa-layers \
	lib32-vulkan-radeon \
	lightdm \
	linux-firmware \
	nvidia-open \
	nvidia-utils \
	pipewire-jack \
	pipewire-pulse \
	rtkit \
	sudo \
	vim \
	vulkan-intel \
	vulkan-mesa-layers \
	vulkan-radeon \
	wireplumber \
	brightnessctl \
	keyd \
	networkmanager \
	iwd \
"

export AUR_PACKAGES="\
	downgrade \
	frzr \
	pikaur \
	udev-media-automount \
"

export SERVICES="\
	fstrim.timer \
	inputplumber \
	lightdm \
	keyd \
	kazeta-profile-loader.service \
"

export FILES_TO_DELETE="\
	/boot/initramfs-linux-fallback.img \
	/usr/share/SFML \
	/usr/share/doc \
	/usr/share/gtk-doc \
	/usr/share/help \
	/usr/share/man \
"

postinstallhook() {
	# --- IMPROVED: Use sudoers.d for better security and consistency ---
	mkdir -p /etc/sudoers.d
	cat <<- 'EOF' > /etc/sudoers.d/99-kazeta-plus
	# Allow running the mount and log copy helpers without a password
	%wheel ALL=(ALL:ALL) NOPASSWD: /usr/bin/kazeta-mount, /usr/bin/kazeta-copy-logs
	EOF
	chmod 440 /etc/sudoers.d/99-kazeta-plus

	# Disable SPDIF/IEC958 audio output
	sed -e '/\[Mapping iec958/,+5 s/^/#/' -i '/usr/share/alsa-card-profile/mixer/profile-sets/default.conf'

	# Set a default timezone
	ln -s /usr/share/zoneinfo/UTC /etc/localtime

	# Persist kazeta save data
	mkdir -p /home/${USERNAME}/.local/share
	ln -s /var/kazeta /home/${USERNAME}/.local/share/kazeta

	# Persist wireplumber settings
	mkdir -p /home/${USERNAME}/.local/state
	ln -s /var/kazeta/state/wireplumber /home/${USERNAME}/.local/state/wireplumber

	# make /var/kazeta dir before setting its permissions
	mkdir -p /var/kazeta

	# Set permissions
	chown -R ${USERNAME}:${USERNAME} /home/${USERNAME}
	chown -R ${USERNAME}:${USERNAME} /var/kazeta

	# Automount storage to /run/media
	sed -i -e 's,mediadir=/media,mediadir=/run/media,' /usr/bin/media-automount
	sed -i -e 's,}.$TYPE",}",' /usr/bin/media-automount

	# Force Xbox 360 emulation for all controller devices
	sed -i -e 's/- xbox-elite/- xb360/' /usr/share/inputplumber/devices/*.yaml
	sed -i -e 's/- xbox-series/- xb360/' /usr/share/inputplumber/devices/*.yaml
	sed -i -e 's/- ds5/- xb360/' /usr/share/inputplumber/devices/*.yaml
	sed -i -e 's/- ds5-edge/- xb360/' /usr/share/inputplumber/devices/*.yaml

    # --- NEW: Configure NetworkManager to use iwd as the Wi-Fi backend ---
    mkdir -p /etc/NetworkManager/conf.d
    cat <<- 'EOF' > /etc/NetworkManager/conf.d/wifi_backend.conf
    [device]
    wifi.backend=iwd
EOF
}
